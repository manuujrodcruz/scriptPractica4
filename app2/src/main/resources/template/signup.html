<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro de Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/login.css">
</head>
<body>
<div class="container">
    <div class="login-container">
        <h1>Registro</h1>

        <form id="signupForm" action="/signup" method="post" enctype="multipart/form-data">
            <input type="text" name="name" placeholder="Nombre" required class="form-control mb-2" id="name"/>
            <input type="text" name="username" placeholder="Usuario" required class="form-control mb-2" id="username"/>
            <input type="password" name="password" placeholder="Contraseña" required class="form-control mb-2" id="password"/>

            <!-- Selector de Roles -->
            <select name="role" class="form-control mb-2" required id="role">
                <option value="Usuario">Usuario</option>
                <option value="Autor">Autor</option>
            </select>

            <!-- Subir foto de perfil -->
            <label for="profilePhoto" class="form-label">Foto de Perfil:</label>
            <input type="file" name="profilePhoto" accept="image/*" class="form-control mb-2" id="profilePhoto" onchange="previewImage(event)"/>

            <!-- Vista previa de la imagen -->
            <img id="preview" src="" alt="Vista previa" class="img-thumbnail mb-2" style="max-width: 150px; display: none;"/>

            <input type="submit" value="Registrarse" class="btn btn-success w-100 mt-3"/>
        </form>

        <a href="/login" class="d-block mt-3">← Iniciar sesión</a>
        <a href="/" class="d-block mt-3">← Volver al inicio</a>
    </div>
</div>

<!-- Dialog de éxito -->
<dialog id="successDialog">
    <p>Registro exitoso</p>
</dialog>

<!-- Dialog de error -->
<dialog id="errorDialog">
    <p id="errorMessage">Error en el registro. Intenta nuevamente.</p>
    <button onclick="cerrarDialogo()">Cerrar</button>
</dialog>

<script>
    // Vista previa de la imagen seleccionada
    function previewImage(event) {
        const preview = document.getElementById("preview");
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function() {
                preview.src = reader.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = "";
            preview.style.display = "none";
        }
    }

    document.getElementById('signupForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // Evitar el envío inmediato del formulario

        const formData = new FormData(event.target);
        const response = await fetch("/signup", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            // Vaciar los campos del formulario y ocultar la vista previa de la imagen
            event.target.reset();
            document.getElementById("preview").src = "";
            document.getElementById("preview").style.display = "none";

            // Mostrar mensaje de éxito
            const dialog = document.getElementById('successDialog');
            dialog.showModal();
            setTimeout(() => {
                window.location.href = "/"; // Redirigir después de 2 segundos
            }, 2000);
        } else {
            const errorData = await response.json().catch(() => ({ error: "Error desconocido" }));
            document.getElementById("errorMessage").textContent = errorData.error || "Error en el registro.";
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('name').value = '';
            document.getElementById('profilePhoto').value = '';
            document.getElementById('preview').src = "";
            document.getElementById('preview').style.display = "none";

            document.getElementById("errorDialog").showModal();

        }
    });

    function cerrarDialogo() {
        document.getElementById("errorDialog").close();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
